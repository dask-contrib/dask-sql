name: Test Rust package

on:
  # always trigger on PR
  push:
    branches:
      - main
  pull_request:
  # manual trigger
  # https://docs.github.com/en/actions/managing-workflow-runs/manually-running-a-workflow
  workflow_dispatch:

env:
  # Disable full debug symbol generation to speed up CI build and keep memory down
  # "1" means line tables only, which is useful for panic tracebacks.
  RUSTFLAGS: "-C debuginfo=1"

jobs:
  # Check crate compiles
  linux-build-lib:
    name: cargo check
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - name: Cache Cargo
        uses: actions/cache@v3
        with:
          path: /home/runner/.cargo
          key: cargo-cache
      - name: Check workspace in debug mode
        run: |
          cd dask_planner
          cargo check
      - name: Check workspace in release mode
        run: |
          cd dask_planner
          cargo check --release

  # test the crate
  linux-test:
    name: cargo test
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
        with:
          submodules: true
      - name: Cache Cargo
        uses: actions/cache@v3
        with:
          path: /home/runner/.cargo
          key: cargo-cache
      - name: Run tests
        run: |
          cd dask_planner
          cargo test
